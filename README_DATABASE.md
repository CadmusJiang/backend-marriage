# 数据库重建使用说明

## 概述

本系统支持通过启动参数来重建数据库，包括删除所有表、重新创建表结构并插入测试数据。

## 启动参数

### 1. 正常启动（检查并创建缺失的表）
```bash
./main
```

### 2. 强制重置数据（清空表数据并重新插入）
```bash
./main -force-reseed
```

### 3. 重建数据库（删除所有表并重新创建）
```bash
./main -rebuild-db
```

### 4. 重建数据库并重置数据
```bash
./main -rebuild-db -force-reseed
```

## 参数说明

| 参数 | 说明 | 影响 |
|------|------|------|
| `-force-reseed` | 强制重置数据 | 清空所有表数据，重新插入测试数据 |
| `-rebuild-db` | 重建数据库 | 删除所有表，重新创建表结构，插入测试数据 |

## 城市编码更新

从 2024-01-13 开始，系统已更新为使用城市编码存储：

### 变更的表
1. **客户授权记录表** (`customer_authorization_record`)
   - 原字段: `city` (城市名称)
   - 新字段: `city_code` (城市编码)

2. **合作门店表** (`cooperation_store`)
   - 原字段: `cooperation_city` (合作城市名称)
   - 新字段: `cooperation_city_code` (合作城市编码)

### 城市编码映射
| 城市编码 | 城市名称 | 省份 | 区域 |
|---------|---------|------|------|
| 110000 | 北京市 | 北京市 | 华北 |
| 310000 | 上海市 | 上海市 | 华东 |
| 440100 | 广州市 | 广东省 | 华南 |
| 440300 | 深圳市 | 广东省 | 华南 |
| 330100 | 杭州市 | 浙江省 | 华东 |
| 320100 | 南京市 | 江苏省 | 华东 |
| 510100 | 成都市 | 四川省 | 西南 |
| 420100 | 武汉市 | 湖北省 | 华中 |
| 610100 | 西安市 | 陕西省 | 西北 |
| 500000 | 重庆市 | 重庆市 | 西南 |

## 使用场景

### 开发环境
```bash
# 首次启动或需要重置数据
./main -rebuild-db

# 日常开发，只重置数据
./main -force-reseed
```

### 生产环境
```bash
# 正常启动，不重建数据库
./main
```

## 注意事项

1. **数据丢失警告**: `-rebuild-db` 参数会删除所有现有数据
2. **生产环境**: 生产环境请勿使用重建参数
3. **备份建议**: 重建前建议备份重要数据
4. **前端适配**: 前端需要适配新的城市编码字段

## 日志输出

重建过程中会输出详细的日志信息：

```
正在强制重建数据库表...
正在删除所有现有表...
删除表: cooperation_store_history
删除表: customer_authorization_record_history
...
所有表删除完成
正在重新创建表...
强制重建表: org
表已存在，正在删除...
表删除完成
正在创建表...
表创建完成
...
正在插入测试数据...
清空表数据: org
插入 mock 数据: org
插入完成: org
...
数据库重建完成
```

## 故障排除

### 1. 数据库连接失败
- 检查数据库配置
- 确认数据库服务运行状态

### 2. 表删除失败
- 检查数据库权限
- 确认没有其他连接占用表

### 3. 数据插入失败
- 检查表结构是否正确
- 确认测试数据格式

## 相关文档

- [城市编码映射表](docs/city_codes.md)
- [数据库设计文档](docs/database_design.md)
