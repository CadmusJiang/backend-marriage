<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿç›‘æ§é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 14px;
        }

        .nav-tabs {
            display: flex;
            background: #fff;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 0;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .nav-tab:hover {
            color: #3498db;
        }

        .tab-content {
            background: #fff;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            min-height: 400px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #2980b9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .info-card {
            background: #e8f4fd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #34495e;
        }

        .info-value {
            color: #7f8c8d;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }

        .session-card {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .session-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #f8f9fa;
        }

        .session-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .session-token {
            font-size: 12px;
            color: #7f8c8d;
            font-family: monospace;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .session-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .event-card {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #27ae60;
        }

        .event-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .event-type.created {
            background: #d4edda;
            color: #155724;
        }

        .event-type.updated {
            background: #fff3cd;
            color: #856404;
        }

        .event-type.deleted {
            background: #f8d7da;
            color: #721c24;
        }

        .json-viewer {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” ç³»ç»Ÿç›‘æ§é¢æ¿</h1>
            <div class="subtitle">å®æ—¶ç›‘æ§ç”¨æˆ·ä¼šè¯ã€äº‹ä»¶æµå’Œæ•°æ®åº“æ“ä½œçŠ¶æ€</div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('sessions')">ğŸ‘¥ ç”¨æˆ·ä¼šè¯</button>
            <button class="nav-tab" onclick="switchTab('events')">ğŸ“¡ äº‹ä»¶æµ</button>
            <button class="nav-tab" onclick="switchTab('redis')">ğŸ”´ RedisçŠ¶æ€</button>
        </div>

        <div class="tab-content">
            <!-- ç”¨æˆ·ä¼šè¯æ ‡ç­¾é¡µ -->
            <div id="sessions-tab" class="tab-pane active">
                <button class="refresh-btn" onclick="loadSessions()">ğŸ”„ åˆ·æ–°ä¼šè¯</button>
                <div id="sessions-loading" class="loading">æ­£åœ¨åŠ è½½ç”¨æˆ·ä¼šè¯ä¿¡æ¯...</div>
                <div id="sessions-error" class="error" style="display: none;"></div>
                <div id="sessions-content" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="sessions-count">0</div>
                            <div class="stat-label">æ´»è·ƒä¼šè¯</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="sessions-timestamp">-</div>
                            <div class="stat-label">æœ€åæ›´æ–°</div>
                        </div>
                    </div>
                    <div id="sessions-list"></div>
                </div>
            </div>

            <!-- äº‹ä»¶æµæ ‡ç­¾é¡µ -->
            <div id="events-tab" class="tab-pane">
                <button class="refresh-btn" onclick="loadEvents()">ğŸ”„ åˆ·æ–°äº‹ä»¶</button>
                <div id="events-loading" class="loading">æ­£åœ¨åŠ è½½äº‹ä»¶æµä¿¡æ¯...</div>
                <div id="events-error" class="error" style="display: none;"></div>
                <div id="events-content" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="events-count">0</div>
                            <div class="stat-label">äº‹ä»¶æ€»æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="events-displayed">0</div>
                            <div class="stat-label">æ˜¾ç¤ºäº‹ä»¶</div>
                        </div>
                    </div>
                    <div id="events-list"></div>
                </div>
            </div>

            <!-- RedisçŠ¶æ€æ ‡ç­¾é¡µ -->
            <div id="redis-tab" class="tab-pane">
                <button class="refresh-btn" onclick="loadRedisStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                <div id="redis-loading" class="loading">æ­£åœ¨åŠ è½½RedisçŠ¶æ€ä¿¡æ¯...</div>
                <div id="redis-error" class="error" style="display: none;"></div>
                <div id="redis-content" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="redis-keys">0</div>
                            <div class="stat-label">æ€»Keyæ•°é‡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="redis-streams">0</div>
                            <div class="stat-label">Streamæ¶ˆæ¯</div>
                        </div>
                    </div>
                    <div id="redis-details"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'sessions';

        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });

            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            currentTab = tabName;

            // åŠ è½½å¯¹åº”æ•°æ®
            switch(tabName) {
                case 'sessions':
                    loadSessions();
                    break;
                case 'events':
                    loadEvents();
                    break;
                case 'redis':
                    loadRedisStatus();
                    break;
            }
        }

        function loadSessions() {
            const loading = document.getElementById('sessions-loading');
            const error = document.getElementById('sessions-error');
            const content = document.getElementById('sessions-content');

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            fetch('/system/sessions')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    content.style.display = 'block';
                    renderSessions(data);
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.style.display = 'block';
                    error.textContent = 'åŠ è½½ç”¨æˆ·ä¼šè¯å¤±è´¥: ' + err.message;
                });
        }

        function renderSessions(data) {
            document.getElementById('sessions-count').textContent = data.total;
            document.getElementById('sessions-timestamp').textContent = data.timestamp;

            const container = document.getElementById('sessions-list');
            
            if (data.total === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ‘¤</div>
                        <div>æš‚æ— æ´»è·ƒç”¨æˆ·ä¼šè¯</div>
                        <div style="font-size: 12px; margin-top: 10px;">ç”¨æˆ·ç™»å½•åä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                    </div>
                `;
                return;
            }

            let sessionsHtml = '';
            data.sessions.forEach(session => {
                // æ ¼å¼åŒ–TTLæ˜¾ç¤º
                const formatTTL = (seconds) => {
                    if (seconds <= 0) return 'å·²è¿‡æœŸ';
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    if (hours > 0) {
                        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                    } else if (minutes > 0) {
                        return `${minutes}åˆ†é’Ÿ${secs}ç§’`;
                    } else {
                        return `${secs}ç§’`;
                    }
                };

                // è·å–çŠ¶æ€æ ·å¼
                const getStatusStyle = (status) => {
                    switch(status) {
                        case 'æ´»è·ƒ': return 'color: #27ae60; font-weight: bold;';
                        case 'æ­£å¸¸': return 'color: #3498db; font-weight: bold;';
                        case 'å³å°†è¿‡æœŸ': return 'color: #f39c12; font-weight: bold;';
                        case 'å·²è¿‡æœŸ': return 'color: #e74c3c; font-weight: bold;';
                        default: return '';
                    }
                };

                // æ ¼å¼åŒ–ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                const formatUserInfo = (userInfo) => {
                    if (!userInfo || Object.keys(userInfo).length === 0) {
                        return 'æ— ç”¨æˆ·ä¿¡æ¯';
                    }
                    const info = [];
                    if (userInfo.user_id) info.push(`ç”¨æˆ·ID: ${userInfo.user_id}`);
                    if (userInfo.user_name) info.push(`ç”¨æˆ·å: ${userInfo.user_name}`);
                    if (userInfo.nickname) info.push(`æ˜µç§°: ${userInfo.nickname}`);
                    if (userInfo.phone) info.push(`æ‰‹æœº: ${userInfo.phone}`);
                    return info.join(', ') || JSON.stringify(userInfo);
                };

                sessionsHtml += `
                    <div class="session-card">
                        <div class="session-header">
                            <div class="session-status" style="${getStatusStyle(session.status)}">
                                ${session.status}
                            </div>
                            <div class="session-actions">
                                <div class="session-token">
                                    Token: ${session.token.substring(0, 20)}...
                                </div>
                                <button class="delete-btn" onclick="deleteSession('${session.token}')" title="åˆ é™¤ä¼šè¯">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                        <div class="session-details">
                            <div class="info-item">
                                <span class="info-label">ç”¨æˆ·ä¿¡æ¯</span>
                                <span class="info-value">${formatUserInfo(session.user_info)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">å‰©ä½™æ—¶é—´</span>
                                <span class="info-value">${formatTTL(session.ttl)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">åˆ›å»ºæ—¶é—´</span>
                                <span class="info-value">${session.created_at}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æœ€åè®¿é—®</span>
                                <span class="info-value">${session.last_access}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = sessionsHtml;
        }

        function loadEvents() {
            const loading = document.getElementById('events-loading');
            const error = document.getElementById('events-error');
            const content = document.getElementById('events-content');

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            fetch('/system/events')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    content.style.display = 'block';
                    renderEvents(data);
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.style.display = 'block';
                    error.textContent = 'åŠ è½½äº‹ä»¶æµå¤±è´¥: ' + err.message;
                });
        }

        function renderEvents(data) {
            document.getElementById('events-count').textContent = data.total;
            document.getElementById('events-displayed').textContent = data.count;

            const container = document.getElementById('events-list');
            
            if (data.total === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“¡</div>
                        <div>æš‚æ— äº‹ä»¶æµæ¶ˆæ¯</div>
                        <div style="font-size: 12px; margin-top: 10px;">åˆ›å»ºæˆ–æ›´æ–°å®¢æˆ·è®°å½•åä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                    </div>
                `;
                return;
            }

            let eventsHtml = '';
            data.events.forEach(event => {
                const eventTypeClass = event.type.includes('created') ? 'created' : 
                                     event.type.includes('updated') ? 'updated' : 'deleted';
                
                eventsHtml += `
                    <div class="event-card">
                        <div class="event-type ${eventTypeClass}">${event.type}</div>
                        <div class="info-item">
                            <span class="info-label">æ¶ˆæ¯ID</span>
                            <span class="info-value">${event.id}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">è®°å½•ID</span>
                            <span class="info-value">${event.record_id}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">æ—¶é—´æˆ³</span>
                            <span class="info-value">${event.timestamp}</span>
                        </div>
                        <div class="info-label" style="margin-top: 15px;">äº‹ä»¶æ•°æ®</div>
                        <div class="json-viewer">${JSON.stringify(event.data, null, 2)}</div>
                    </div>
                `;
            });

            container.innerHTML = eventsHtml;
        }

        function loadRedisStatus() {
            const loading = document.getElementById('redis-loading');
            const error = document.getElementById('redis-error');
            const content = document.getElementById('redis-content');

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            fetch('/system/redis/status')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    content.style.display = 'block';
                    renderRedisStatus(data);
                })
                .catch(err => {
                    loading.style.display = 'none';
                    error.style.display = 'block';
                    error.textContent = 'åŠ è½½RedisçŠ¶æ€å¤±è´¥: ' + err.message;
                });
        }

        function renderRedisStatus(data) {
            document.getElementById('redis-keys').textContent = data.keys.total.count;
            document.getElementById('redis-streams').textContent = data.streams.customer_record.length;

            const container = document.getElementById('redis-details');
            
            let redisHtml = '';
            
            // è¿æ¥çŠ¶æ€
            redisHtml += `
                <div class="info-card">
                    <h3>ğŸ”Œ è¿æ¥çŠ¶æ€</h3>
                    <div class="info-item">
                        <span class="info-label">çŠ¶æ€</span>
                        <span class="info-value">${data.connection.status}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">åœ°å€</span>
                        <span class="info-value">${data.connection.addr}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ•°æ®åº“</span>
                        <span class="info-value">${data.connection.db}</span>
                    </div>
                </div>
            `;

            // Keyç»Ÿè®¡
            redisHtml += `
                <div class="info-card">
                    <h3>ğŸ”‘ Keyç»Ÿè®¡</h3>
                    <div class="info-item">
                        <span class="info-label">ç™»å½•ç”¨æˆ·</span>
                        <span class="info-value">${data.keys.login_users.count}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ç­¾åéªŒè¯</span>
                        <span class="info-value">${data.keys.signatures.count}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ€»Keyæ•°</span>
                        <span class="info-value">${data.keys.total.count}</span>
                    </div>
                </div>
            `;

            // Streamsä¿¡æ¯
            redisHtml += `
                <div class="info-card">
                    <h3>ğŸ“¡ Streamsä¿¡æ¯</h3>
                    <div class="info-item">
                        <span class="info-label">Streamåç§°</span>
                        <span class="info-value">${data.streams.customer_record.name}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ¶ˆæ¯æ•°é‡</span>
                        <span class="info-value">${data.streams.customer_record.length}</span>
                    </div>
                </div>
            `;

            container.innerHTML = redisHtml;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
        });

        // åˆ é™¤ä¼šè¯å‡½æ•°
        function deleteSession(token) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿåˆ é™¤åç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚')) {
                return;
            }

            fetch(`/system/sessions/${token}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    alert('ä¼šè¯åˆ é™¤æˆåŠŸ');
                    loadSessions(); // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(err => {
                alert('åˆ é™¤å¤±è´¥: ' + err.message);
            });
        }

        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°å½“å‰æ ‡ç­¾é¡µ
        setInterval(() => {
            switch(currentTab) {
                case 'sessions':
                    loadSessions();
                    break;
                case 'events':
                    loadEvents();
                    break;
                case 'redis':
                    loadRedisStatus();
                    break;
            }
        }, 30000);
    </script>
</body>
</html>
